

\section{Soma DSP Board FPGA Design}


  The DSP Board uses a Xilinx Spartan-3 XC3S200 FPGA as the glue
  between the two DSPs, the Acqboard optical interface, and the system
  Event and Data buses.
  
  \begin{figure}
  \includegraphics[width=7in]{FPGAOverview.pdf}
  \end{figure}

  The VHDL module consists of identicial interfaces for each DSP (A
  and B) and modules to multiplex their access to shared resources
  (the event bus, the Data bus, and the acqboard optical RX/TX). The
  66.6 MHz \signal{ CLK } and 20 MHz \signal{SYSCLK}
  are derived from the system bus \signal{SYSCLK} via the
  Spartan-3 DCM.
    
  
  The \signal{MODE} signal determines whether a given DSP is
  in boot mode (\signal{MODE} high) or regular mode. This
  impacts whether the interface is the 8-bit boot interface or the
  16-bit regular operaton interface, and how the Data Buffer memory is
  used.
  
  Nearly all internal modules behave as memory-mapped peripherals,
  controlled by various read and write-enable lines generated by
  <module>DSPIO</module>. The relevant bits of the
  \bus{15:0}{ADDROUT} are routed to the various components for each
  DSP (thus the existence of \bus{15:0}{ADDROUTA} and
  \bus{15:0}b{ADDROUTB} for DSPs A and B, respectively. Common
  resources like the data bus, event bus, and fiber interfaces are
  shared via multiplexors.
  
  Data is decoded from the acqboard fiber input via the Fiber RX
  interface, and a new round of samples is indicated by the assertion
  of \signal{NEWSAMPLES}.

\subsection{DSPIO}

\begin{figure}
\includegraphics[width=5in]{DSPIO.pdf}
\end{figure}

The interface to the DSP Parallel Port occurs via \signal{ALE},
\bus{15:0}{DATA}, \signaln{RD}, and \signaln{WE}. All input stages are
heavily registered, and a full read must complete before the next can
begin (i.e. you cannot pipeline reads)

  
The \signal{ALE} asynchronously latches the address word onto
\bus{15:0}{ADDR}, and \signaln{RD} and \signaln{WE} are sampled into
the \signal{CLK} domain. The extra pipeline stages following these
signals address metastability concerns arising from the asynchronous
nature of the parallel port.
  
Write-enables to the rest of the FPGA arise from measuring the
difference between \signal{WELL} and \signal{WELLL} to form a
\signal{DELTAWE}, and anding that with various address checks. Thus
the mapping of \signal{DWE} (data write-enable), \signal{EWE} (event
write-enable), and \signal{CWE} (command write-enable) into the
Parallel Port memory space is determined at an early stage, and can be
re-assigned if necessary later.
    
The signal \signal{DELTARD} arises from \signaln{RD} in a similar
fashion, as does \signal{ERD}. Note, however, that \signal{ERD} is
\em{not} a delta.
  
Spartan-3 output tristates are used to selectively tristate the high
and low bytes of the \bus{15:0}{DATA} lines: All outputs are tristated
whenever \signaln{RD } is asserted, and \bus{15:0}{DATA} is also
tristated during boot-mode (to allow for 24-bit addressing, currently
unused).
  
Similarly, \bus{15:0}{DATAOUT} is driven by \bus{15:0}{DMUX} when in
normal mode, and \bus{7:0}{RDIN} when in boot mode.\bus{15:0}{DMUX} is
the result of multiplexing the \bus{15:0}{EVENTDIN} and the various
input samples and status words. This multiplexing is all controlled by
the appropriate bits of \bus{15:0}{ADDR}.


The extra control signals, including \signal{TINC}, \signal{EVENTS},
\signal{TCLR}, \signal{SAMPLES}, and the DSP \signaln{RESET} are all
registered before leaving the FPGA.
    

\end{document}
