\section{Events}
The following is a general overview of how the DSP board interacts with the rest of the Soma system via the Event Bus. 

1. acqboard control
2. Configuration events
3. thresholding, spike windowing
4. buffer / filter configuration
5. timing 
6. Boot control

\subsection{Acquisition Board Control}
Any change of the analog acqboard state result in a tetrode state update event. This event is broadcast from the relevant tetrode to all devices. 

\begin{figure}[h]
\begin{event}{CHANSTATE}
CMD: 0x45
SRC: TETN
DW0[3:0]: G1
DW0[7:4]: HWF1
DW1[3:0]: G2
DW1[7:4]: HWF2
DW2[3:0]: G3
DW2[7:4]: HWF3
DW3[3:0]: G4
DW3[7:4]: HWF4
DW4[3:0]: GC
DW4[7:4]: HWFC
DW4[9:8]: CS
\end{event}
\end{figure}

Where \textbf{Gn} is the gain of channel \textbf{n} and \textbf{HWFn} is the high pass filter selection of channel \textbf{n}. For the continuous acquisition channel, \textbf{CS} is the currently muxed channel. 
/
[something about gain settings here] 

To explicitly query these settings, send 

\begin{figure}[h]
\begin{event}{CHANQUERY}
CMD: 0x46
SRC: ANY
\end{event}
\end{figure}

All tetrodes which receive such a query will broadcast a CHANSTATE. 

-- to set gain, use chan event 0x47
-- to set hpf, use chan event 0x48
-- to set input sel, use chan event 0x49



\subsection{Configuration Events}
Most of the configuration parameters in the DSP board are set and queried via two events. This is to reduce the impact on the event space for events that are infrequently accessed. 

\subsubsection{Read Configuration Parameter}

\begin{figure}[h]
\begin{event}{READPARAM}
CMD: 0x41
SRC: ANY
DW0[7:0]: TARGET
DW0[15:8]: ADDR
DW1: DW0[31:16]
DW2: DW0[15:0]
DW3: DW1[31:16]
DW4: DW1[15:0]
\end{event}
\end{figure}

\subsubsection{Write Configuration Parameter}
\begin{figure}[h]
\begin{event}{WRITEPARAM}
CMD: 0x42
SRC: ANY
DW0[7:0]: TARGET
DW0[15:8]: ADDR
DW1: DW0[31:16]
DW2: DW0[15:0]
DW3: DW1[31:16]
DW4: DW1[15:0]
\end{event}
\end{figure}

\subsubsection{Configuration Parameters}

\begin{figure}[h]
\begin{dspcmd}{WRITEFILTER}
TARGET: 0x1n
ADDR: n
DW0[31:0]: 32-bit h[n]
DW1[31:0]: 32-bit h[n+1]
\end{dspcmd}
\caption{DSP Configuration Parameter: Set Filter}
\end{figure}

Writes the 32-bit filter coefficient. 

\begin{figure}[h]
\begin{dspcmd}{WRITEFILTERLENID}
TARGET: 0x20
ADDR: TGT
DW0[7:0]: LENGTH
DW1[15:0]: ID
\end{dspcmd}
\caption{DSP Configuration Parameter: Filter Length}
\end{figure}
Writes the filter length and the unique 16-bit filter ID. 


\begin{figure}[h]
\begin{dspcmd}{SPIKELEN}
TARGET: 0x23
DW0[7:0]: SPLEN
\end{dspcmd}
\caption{DSP Configuration Parameter: Spike Window Length}
\end{figure}

\begin{figure}[h]
\begin{dspcmd}{NOTRIGGERLEN}
TARGET: 0x24
DW0[7:0]: NTLEN
\end{dspcmd}
\caption{DSP Configuration Parameter: Length of non-trigger}
\end{figure}

\begin{figure}[h]
\begin{dspcmd}{POSTTRIGLEN}
TARGET: 0x25
DW0[7:0]: PTLEN
\end{dspcmd}
\caption{DSP Configuration Parameter: Post-trigger length}
\end{figure}

Change continuous parameters

\begin{figure}[h]
\begin{dspcmd}{DSRATIO}
TARGET: 0x26
DW0[3:0]: RATIO
\end{dspcmd}
\caption{DSP Configuration Parameter: Downsampling ratio}
\end{figure}
The input for continuous data is sampled at such and such a rate. 


\begin{figure}[h]
\begin{dspcmd}{CFSIZE}
TARGET: 0x27
DW0[15:0]: FSIZE
\end{dspcmd}
\caption{DSP Configuration Parameter: Cont. Frame size}
\end{figure}
Number of continuous samples per frame.




